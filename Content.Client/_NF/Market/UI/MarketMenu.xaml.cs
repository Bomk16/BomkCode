using Content.Client.UserInterface.Controls;
using Content.Server.Cargo.Components;
using Content.Shared._NF.Market;
using Content.Shared._NF.Market.BUI;
using Content.Shared.Cargo.Components;
using Content.Shared.Materials;
using Robust.Client.AutoGenerated;
using Robust.Client.GameObjects;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;

namespace Content.Client._NF.Market.UI;

[GenerateTypedNameReferences]
public sealed partial class MarketMenu : FancyWindow
{
    [Dependency] private readonly IPrototypeManager _protoManager = default!;
    [Dependency] private readonly IEntitySystemManager _entitySystem = default!;

    public event Action<BaseButton.ButtonEventArgs>? OnPurchase;
    public event Action<BaseButton.ButtonEventArgs>? OnReturn;
    public event Action<BaseButton.ButtonEventArgs>? OnPurchaseCrate;

    public MarketMenu()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        PurchaseCrate.OnPressed += args => OnPurchaseCrate?.Invoke(args);
    }

    public void SetEnabled(bool enabled)
    {
        // TODO disable buttons where possible
    }

    public void Populate(List<MarketData> data, List<MarketData> cartData, float marketModifier)
    {
        Products.RemoveAllChildren();
        Cart.RemoveAllChildren();

        foreach (var marketData in data)
        {
            var price = 0f;

            string spawnedPrototype = marketData.Prototype;

            if (marketData.Prototype[0] == '%' && _protoManager.TryIndex<MaterialPrototype>(marketData.Prototype[1..], out var materialPrototype))
            {
                if (materialPrototype.StackEntity == null)
                    continue;

                spawnedPrototype = materialPrototype.StackEntity;
                price = (float) materialPrototype.Price;
            }
            // Try to get the EntityPrototype that matches marketData.Prototype
            if (!_protoManager.TryIndex<EntityPrototype>(spawnedPrototype, out var prototype))
            {
                continue; // Skip this iteration if the prototype was not found
            }
            if (!prototype.TryGetComponent<SpriteComponent>(out var sprite))
            {
                continue; // Skip this iteration if the prototype was not found
            }

            if (prototype.TryGetComponent<StaticPriceComponent>(out var staticPrice))
            {
                price = (float) (staticPrice.Price * marketModifier);
            }
            var roundedPrice = (int)Math.Round(price);

            var productRow = new MarketProductRow(marketData.Prototype)
            {
                Title = { Text = prototype.Name },
                Quantity = { Text = marketData.Quantity.ToString() },
                Price = { Text = $"${roundedPrice}" },
                Icon = { Texture = sprite.Icon?.Default }
            };
            productRow.Purchase.OnPressed += args => { OnPurchase?.Invoke(args); };

            Products.AddChild(productRow);
        }

        foreach (var marketData in cartData)
        {
            var price = 0f;

            var spawnedPrototype = marketData.Prototype;

            if (marketData.Prototype[0] == '%' && _protoManager.TryIndex<MaterialPrototype>(marketData.Prototype[1..], out var materialPrototype))
            {
                spawnedPrototype = materialPrototype.StackEntity;
                price = _entitySystem.GetEntitySystem<SharedMarketSystem>().StandardMaterialAmount(materialPrototype) * (float) materialPrototype.Price;
            }

            // Try to get the EntityPrototype that matches marketData.Prototype
            if (!_protoManager.TryIndex<EntityPrototype>(spawnedPrototype!, out var prototype))
            {
                continue; // Skip this iteration if the prototype was not found
            }
            if (!prototype.TryGetComponent<SpriteComponent>(out var sprite))
            {
                continue; // Skip this iteration if the prototype was not found
            }

            // respect static price except for mats
            if (prototype.TryGetComponent<StaticPriceComponent>(out var staticPrice) && marketData.Prototype[0] != '%')
            {
                price = (float) (staticPrice.Price * marketModifier);
            }

            var roundedPrice = (int)Math.Round(price);

            var productRow = new MarketCartProductRow(marketData.Prototype)
            {
                Title = { Text = prototype.Name },
                Quantity = { Text = marketData.Quantity.ToString() },
                Price = { Text = $"${roundedPrice}" },
                Icon = { Texture = sprite.Icon?.Default }
            };
            productRow.Return.OnPressed += args => { OnReturn?.Invoke(args); };

            Cart.AddChild(productRow);
        }
    }

    public void UpdateState(MarketConsoleInterfaceState uiState)
    {
        Populate(uiState.MarketDataList, uiState.CartDataList, uiState.MarketModifier);
        BalanceLabel.Text = $" ${uiState.Balance}";
        CartBalanceLabel.Text = $" ${uiState.CartBalance}";
    }
}
